name: Build SM64CoopDX AppImage (FUSE 2/3 Compatible)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release (e.g., v1.4-fuse3)'
        required: true
        type: string
      create_release:
        description: 'Create a GitHub release?'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

env:
  APPIMAGE_EXTRACT_AND_RUN: 1
  ARCH: x86_64
  BUILDER_SCRIPT: "0-builder.py"

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install System Dependencies
        run: |
          echo "ðŸ“¦ Instalando dependencias del sistema..."
          sudo apt-get update
          sudo apt-get install -y \
            libsdl2-2.0-0 \
            libsdl2-dev \
            libglew2.2 \
            libglew-dev \
            libglu1-mesa \
            libopenal1 \
            libusb-1.0-0 \
            file \
            desktop-file-utils \
            wget
          echo "Dependencias instaladas correctamente"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests rich

      - name: Download go-appimage
        run: |
          echo "ðŸ“¥ Descargando go-appimage (appimagetool-940)..."
          wget -q "https://github.com/probonopd/go-appimage/releases/download/continuous/appimagetool-940-x86_64.AppImage" \
            -O appimagetool-940-x86_64.AppImage
          chmod +x appimagetool-940-x86_64.AppImage
          echo "go-appimage descargado: $(ls -lh appimagetool-940-x86_64.AppImage)"

      - name: Prepare Assets
        run: |
          mkdir -p assets
          mv appimagetool-940-x86_64.AppImage assets/
          
          # Manejar icono (descargar si no existe)
          if [ ! -f sm64coopdx.png ]; then
            echo "âš ï¸  Icono no encontrado en el repo, descargando..."
            # Intentar descargar desde el repo oficial
            wget -q "https://raw.githubusercontent.com/retired64/Sm64coopdx.AppImage/refs/heads/main/sm64coopdx.png" \
              -O sm64coopdx.png 2>/dev/null || \
            # Fallback a placeholder
            wget -q "https://via.placeholder.com/256/0066cc/ffffff?text=SM64" \
              -O sm64coopdx.png || {
              echo "::error::No se pudo descargar el icono"
              exit 1
            }
          fi
          
          if [ -f sm64coopdx.png ]; then
            mv sm64coopdx.png assets/
            echo "Icono preparado: $(file assets/sm64coopdx.png)"
          else
            echo "::error::No se pudo obtener el icono sm64coopdx.png"
            exit 1
          fi
          
          echo "ðŸ“¦ Contenido de assets:"
          ls -lh assets/

      - name: Run Builder
        id: build
        run: |
          echo "ðŸ”¨ Construyendo AppImage con FUSE 2/3 compatibility..."
          python "$BUILDER_SCRIPT"
          
          # Capturar nombres de archivos generados
          APPIMAGE=$(ls Sm64CoopDX-*-x86_64.AppImage 2>/dev/null | head -n1)
          MODS_ZIP=$(ls mods-*.zip 2>/dev/null | head -n1)
          
          echo "appimage_name=$APPIMAGE" >> $GITHUB_OUTPUT
          echo "mods_name=$MODS_ZIP" >> $GITHUB_OUTPUT

      - name: Verify Build
        run: |
          echo "ðŸ“¦ Verificando archivos generados..."
          
          APPIMAGE="${{ steps.build.outputs.appimage_name }}"
          MODS_ZIP="${{ steps.build.outputs.mods_name }}"
          
          if [ -z "$APPIMAGE" ] || [ ! -f "$APPIMAGE" ]; then
            echo "::error::No se generÃ³ el AppImage"
            echo "Contenido del directorio:"
            ls -la
            exit 1
          fi
          
          # Verificar tipo de archivo
          echo "AppImage generado: $APPIMAGE"
          file "$APPIMAGE"
          ls -lh "$APPIMAGE"
          
          if [ -n "$MODS_ZIP" ] && [ -f "$MODS_ZIP" ]; then
            echo "Mods generados: $MODS_ZIP"
            ls -lh "$MODS_ZIP"
          else
            echo "âš ï¸  Archivo de mods no encontrado"
          fi
          
          # Verificar que sea ejecutable
          if [ ! -x "$APPIMAGE" ]; then
            echo "âš ï¸  AppImage no es ejecutable, aplicando permisos..."
            chmod +x "$APPIMAGE"
          fi
          
          # InformaciÃ³n adicional
          echo "ðŸ“Š TamaÃ±o del AppImage: $(du -h "$APPIMAGE" | cut -f1)"

      - name: Create Tag (manual workflow only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          
          echo "ðŸ·ï¸  Procesando tag: $TAG_NAME"
          
          # Configurar git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Verificar si el tag existe localmente
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $TAG_NAME ya existe localmente"
          else
            echo "Creando nuevo tag: $TAG_NAME"
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME - FUSE 2/3 Compatible AppImage"
          fi
          
          # Intentar push (ignorar error si ya existe remotamente)
          if git push origin "$TAG_NAME" 2>&1 | tee push.log; then
            echo "Tag pusheado exitosamente"
          else
            if grep -q "already exists" push.log; then
              echo "âš ï¸  Tag ya existe remotamente, continuando..."
            else
              echo "::error::Error al pushear tag"
              cat push.log
              exit 1
            fi
          fi
          
          # Esperar a que GitHub procese el tag
          echo "â³ Esperando sincronizaciÃ³n con GitHub..."
          sleep 5
          
          # Limpiar log temporal
          rm -f push.log

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: |
          startsWith(github.ref, 'refs/tags/') || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        with:
          tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
          name: "SM64 Coop Deluxe ${{ github.event.inputs.tag_name || github.ref_name }}"
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            Sm64CoopDX-*-x86_64.AppImage
            mods-*.zip
          body: |
            ## SM64 Coop Deluxe AppImage
            
            ### What's New
            - Built with **go-appimage** for universal compatibility
            - **FUSE 2** and **FUSE 3** support out of the box
            - Works on modern distros (CachyOS, Fedora 40+, Arch, NixOS)
            - Works on traditional distros (Ubuntu, Debian, Mint)
            - No installation required - just download and run!
            
            ### Downloads
            - **${{ steps.build.outputs.appimage_name }}** - Main application (portable)
            - **${{ steps.build.outputs.mods_name }}** - Mods package (optional)
            
            ### Quick Start
            ```bash
            # Make executable
            chmod +x ${{ steps.build.outputs.appimage_name }}
            
            # Run the game
            ./${{ steps.build.outputs.appimage_name }}
            ```
            
            ### Requirements
            - Place your ROM at: `~/.local/share/sm64coopdx/baserom.us.z64`
            - Works on any modern Linux distribution
            - No FUSE installation needed (auto-detects FUSE 2 or 3)
            
            ### Troubleshooting
            If the AppImage doesn't run:
            ```bash
            # Extract and run directly
            ./${{ steps.build.outputs.appimage_name }} --appimage-extract-and-run
            ```
            
            ---
            **Built by:** Retired64  
            **Build tool:** go-appimage (appimagetool-940)  
            **Build trigger:** ${{ github.event_name == 'workflow_dispatch' && 'Manual workflow dispatch' || format('Git tag push: {0}', github.ref_name) }}  
            **Build date:** ${{ github.event.repository.updated_at }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_number }}
          path: |
            Sm64CoopDX-*-x86_64.AppImage
            mods-*.zip
            *.log
          retention-days: 30
          if-no-files-found: warn

      - name: Build Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          APPIMAGE="${{ steps.build.outputs.appimage_name }}"
          MODS_ZIP="${{ steps.build.outputs.mods_name }}"
          
          if [ -f "$APPIMAGE" ]; then
            echo "### Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "**Generated Files:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lh "$APPIMAGE" "$MODS_ZIP" 2>/dev/null || echo "Some files not found"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "**AppImage Details:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Name: $APPIMAGE"
            echo "Size: $(du -h "$APPIMAGE" | cut -f1)"
            echo "Type: $(file -b "$APPIMAGE")"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "$MODS_ZIP" ] && [ -f "$MODS_ZIP" ]; then
              echo "**Mods Package:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "Name: $MODS_ZIP"
              echo "Size: $(du -h "$MODS_ZIP" | cut -f1)"
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Available files:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -la
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Workflow: \`${{ github.workflow }}\` | Run: \`#${{ github.run_number }}\` | Trigger: \`${{ github.event_name }}\`_" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup on Failure
        if: failure()
        run: |
          echo "ðŸ§¹ Limpiando archivos temporales despuÃ©s de fallo..."
          rm -rf AppDir _temp_extract *.log 2>/dev/null || true
          echo "Limpieza completada"
